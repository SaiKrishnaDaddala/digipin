<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Frontend Tests</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-2.19.1.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture">
    <!-- Updated fixture reflecting new UI structure from index.html's controls-container -->
    <div id="controls-container">
      <button id="use-location-button">Use My Location</button>
      <input type="text" id="digipin-input" placeholder="Enter DIGIPIN">
      <button id="decode-button">Decode DIGIPIN</button>
      <input type="number" id="lat-input" placeholder="Latitude" step="any">
      <input type="number" id="lon-input" placeholder="Longitude" step="any">
      <button id="coords-to-digipin-button">Get DIGIPIN from Coords</button>
      <div id="digipin-display">[DIGIPIN will appear here]</div>
    </div>
    <div id="map-container" style="height: 100px;"></div> <!-- Basic map container for tests -->
  </div>

  <script src="https://code.jquery.com/qunit/qunit-2.19.1.js"></script>

  <script>
    // Mock Leaflet (L) and its components
    window.L = {
      map: function(id) {
        console.log('Mock L.map called with id:', id);
        return {
          setView: function() { console.log('Mock map.setView called'); return this; },
          addLayer: function() { console.log('Mock map.addLayer called'); return this; },
          on: function(event, handler) { console.log('Mock map.on("'+event+'") called'); if(event === 'click') {this._mapClickHandler = handler;} return this; }, // Store click handler
          eachLayer: function(callback) { console.log('Mock map.eachLayer called'); /* Simulate no existing markers */ },
          removeLayer: function() { console.log('Mock map.removeLayer called'); return this; },
          // Simulate click event for testing
          _simulateClick: function(lat, lng) {
            if (this._mapClickHandler) {
              this._mapClickHandler({ latlng: { lat: lat, lng: lng } });
            }
          }
        };
      },
      tileLayer: function() {
        return { addTo: function() { console.log('Mock L.tileLayer.addTo called'); } };
      },
      marker: function() {
        return {
          addTo: function() { console.log('Mock L.marker.addTo called'); return this; },
          bindPopup: function() { console.log('Mock L.marker.bindPopup called'); return this; },
          openPopup: function() { console.log('Mock L.marker.openPopup called'); return this; }
        };
      },
      Control: {
        geocoder: function(options) {
          console.log('Mock L.Control.geocoder called');
          return {
            on: function(event, handler) { console.log('Mock geocoder.on("'+event+'") called'); if(event === 'markgeocode') {this._geocodeHandler = handler;} return this; },
            addTo: function() { console.log('Mock geocoder.addTo called'); return this; },
            // Simulate geocode event for testing
            _simulateGeocode: function(lat, lng, name) {
              if (this._geocodeHandler) {
                this._geocodeHandler({ geocode: { name: name, center: { lat: lat, lng: lng } } });
              }
            }
          };
        }
      }
    };

    // Mock navigator.geolocation
    window.navigator.geolocation = {
      getCurrentPosition: function(successCallback, errorCallback) {
        console.log('Mock navigator.geolocation.getCurrentPosition called');
        if (this._shouldSucceed) {
          successCallback({ coords: { latitude: this._lat, longitude: this._lng } });
        } else {
          errorCallback({ code: this._errorCode || 1, message: "Mock geolocation error" });
        }
      },
      _shouldSucceed: true,
      _lat: 0, _lng: 0, _errorCode: 1,
      _setMockPosition: function(lat, lng) { this._lat = lat; this._lng = lng; this._shouldSucceed = true; },
      _setMockError: function(code) { this._errorCode = code; this._shouldSucceed = false; }
    };
  </script>

  <script src="script.js"></script>
  <script src="tests.js"></script>
</body>
</html>
